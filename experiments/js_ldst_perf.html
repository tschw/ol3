<!doctype html>
<html>
    <head>
        <title>Locals, Typed Arrays, JS Arrays, Load/Store Performance Test</title>

        <script type="text/javascript">

            function onLoad() {
                var resultLog = [ ];

                var startTime = Date.now();
                var sum = 0;
                for (var i = 0; i < 2500; ++i) {
                    for (var j = 0; j < 2000; ++j) {

                        sum += Math.sqrt(i*i + j*j);
                    }
                }
                resultLog.push('All ld/st access via local scope variables, got result ' + sum + ' time: ' + (Date.now() - startTime));

                startTime = Date.now();
                arr = [0,0];
                sum = 0;
                for (arr[0] = 0; arr[0] < 2500; ++arr[0]) {
                    for (arr[1] = 0; arr[1] < 2000; ++arr[1]) {
                        sum += Math.sqrt(arr[0]*arr[0] + arr[1]*arr[1]);
                    }
                }
                resultLog.push('Load via javascript arrays, got result ' + sum + ' time: ' + (Date.now() - startTime));

                startTime = Date.now();
                arr = new Float32Array(2);
                sum = 0;
                for (arr[0] = 0; arr[0] < 2500; ++arr[0]) {
                    for (arr[1] = 0; arr[1] < 2000; ++arr[1]) {
                        sum += Math.sqrt(arr[0]*arr[0] + arr[1]*arr[1]);
                    }
                }
                resultLog.push('Load via typed arrays, got result ' + sum + ' time: ' + (Date.now() - startTime));

                startTime = Date.now();
                sum = [0];
                for (var i = 0; i < 2500; ++i) {
                    for (var j = 0; j < 2000; ++j) {

                        sum[0] += Math.sqrt(i*i + j*j);
                    }
                }
                resultLog.push('Store via javascript arrays, got result ' + sum[0] + ' time: ' + (Date.now() - startTime));

                startTime = Date.now();
                sum = new Float32Array(1);
                sum[0] = 0;
                for (var i = 0; i < 2500; ++i) {
                    for (var j = 0; j < 2000; ++j) {

                        sum[0] += Math.sqrt(i*i + j*j);
                    }
                }
                resultLog.push('Store via typed arrays, got result ' + sum[0] + ' time: ' + (Date.now() - startTime));
                resultLog.push('');
                resultLog.push('Load:store ratio in above tests is ~ 10:1');
                resultLog.push('Writing to typed arrays is suprisingly slow on some browsers.');
                resultLog.push('');
                resultLog.push('');

                startTime = Date.now();
                arr = [];
                for (var i = 0; i < 5000000; ++i) {
                    arr.push(0);
                }
                resultLog.push('Fill via push to empty array, time: ' + (Date.now() - startTime));
                
                startTime = Date.now();
                arr = [];
                for (var i = 0; i < 5000000; ++i) {
                    arr[i] = 1;
                }
                resultLog.push('Fill via subscript on empty array, time: ' + (Date.now() - startTime));

                startTime = Date.now();
                arr =      new Array(4999999);
                for (var i = 0; i < 5000000; ++i) {
                    arr[i] = 1;
                }
                resultLog.push('Fill via Subscript (size set in array ctor), time: ' + (Date.now() - startTime));



                document.getElementById('results').innerHTML = resultLog.join('<br/>\n');

            }

        </script>
    </head>
    <body onload="javascript: onLoad();" >
        <div id="results">
            Test running...
        </div>
    </body>
</html>
